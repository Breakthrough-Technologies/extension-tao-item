define("taoItems/controller/routes",[],function(){return{Items:{actions:{editItem:"controller/items/edit"}},ItemPreview:{actions:{index:"controller/preview/itemRunner"}}}}),define("taoItems/controller/items/edit",["module","layout/actions"],function(module,actions){var editItemController={start:function(){var config=module.config(),previewAction=(!!config.isPreviewEnabled,!!config.isAuthoringEnabled,actions.getBy("item-preview")),authoringAction=actions.getBy("item-authoring");previewAction&&(previewAction.state.disabled=!config.isPreviewEnabled),authoringAction&&(authoringAction.state.disabled=!config.isAuthoringEnabled),actions.updateState()}};return editItemController
}),define("serviceApi/ServiceApi",["jquery","urlParser","iframeResizer"],function($,UrlParser){function ServiceApi(baseUrl,parameters,serviceCallId,stateStorage,userService){this.baseUrl=baseUrl,this.parameters=parameters,this.connected=!1,this.serviceCallId=serviceCallId,this.state=stateStorage,this.userService=userService,this.onFinishCallback,this.onKillCallback,this.onDisplayChangeCallback}return ServiceApi.SIG_SUCCESS=0,ServiceApi.SIG_ERROR=1,ServiceApi.prototype.loadInto=function(frame,connected){var self=this,$frame=$(frame),callUrl=this.getCallUrl(),isCORSAllowed=new UrlParser(callUrl).checkCORS();$frame.one("load",function(){$(document).on("serviceready",function(){self.connect(frame,connected)
})}).on("load.cors",function(){isCORSAllowed===!0&&(frame.contentWindow.__knownParent__=!0)}),$frame.attr("src",callUrl)},ServiceApi.prototype.connect=function(frame,connected){this.connected===!1&&frame.contentWindow&&"function"==typeof frame.contentWindow.onServiceApiReady&&(frame.contentWindow.onServiceApiReady(this),this.connected=!0,"function"==typeof connected&&connected())},ServiceApi.prototype.getCallUrl=function(){var params=this.parameters||{};return params.serviceCallId=this.serviceCallId,this.baseUrl+"?"+$.param(params)},ServiceApi.prototype.getUserPropertyValues=function(property,callback){this.userService.get(property,callback)},ServiceApi.prototype.getServiceCallId=function(){return this.serviceCallId
},ServiceApi.prototype.getState=function(){return this.state.get()},ServiceApi.prototype.setState=function(state,callback){return this.state.set(state,callback)},ServiceApi.prototype.getParameter=function(identifier){return"undefined"!=typeof this.parameters[identifier]?this.parameters[identifier]:null},ServiceApi.prototype.onFinish=function(callback){this.onFinishCallback=callback},ServiceApi.prototype.onKill=function(callback){this.onKillCallback=callback},ServiceApi.prototype.kill=function(callback){"function"==typeof this.onKillCallback?this.onKillCallback(callback):callback(0)},ServiceApi.prototype.finish=function(valueArray){"function"==typeof this.onFinishCallback&&this.onFinishCallback(valueArray)
},ServiceApi}),define("serviceApi/PseudoStorage",[],function(){function PseudoStorage(){}return PseudoStorage.prototype.get=function(callback){return"function"==typeof callback&&callback(null),null},PseudoStorage.prototype.set=function(state,callback){"function"==typeof callback&&callback()},PseudoStorage}),define("serviceApi/UserInfoService",["jquery"],function($){function UserInfoService(requestUrl,data){this.data=data,this.requestUrl=requestUrl}return UserInfoService.prototype.get=function(property,callback){this.data.hasOwnProperty(property)?"function"==typeof callback&&callback(this.data[property]):$.ajax({url:this.requestUrl,data:{property:property},type:"post",dataType:"json",success:function(service,callback){return function(r){for(key in r.data)service.data[key]=r.data[key];
"function"==typeof callback&&callback(service.data[property])}}(this,callback)})},UserInfoService}),define("taoItems/runtime/ItemServiceImpl",["jquery"],function($){function ItemServiceImpl(data){this.itemId=data.itemId,this.serviceApi=data.serviceApi,this.resultApi=data.resultApi||null,this.params=data.params||{},this.responses={},this.scores={},this.events={},this.connected=!1;var rawstate=this.serviceApi.getState(),state="undefined"==typeof rawstate||null===rawstate?{}:$.parseJSON(rawstate);this.stateVariables="object"==typeof state?state:{},this.beforeFinishCallbacks=[]}return ItemServiceImpl.prototype.connect=function(frame){this.connected===!1&&frame.contentWindow&&(frame.contentWindow.itemApi=this,"function"==typeof frame.contentWindow.onItemApiReady&&(frame.contentWindow.onItemApiReady(this),this.connected=!0))
},ItemServiceImpl.prototype.saveResponses=function(valueArray){for(var attrname in valueArray)this.responses[attrname]=valueArray[attrname]},ItemServiceImpl.prototype.traceEvents=function(eventArray){for(var attrname in eventArray)this.events[attrname]=eventArray[attrname]},ItemServiceImpl.prototype.saveScores=function(valueArray){for(var attrname in valueArray)this.scores[attrname]=valueArray[attrname]},ItemServiceImpl.prototype.getUserPropertyValues=function(property,callback){this.serviceApi.getUserPropertyValues(property,callback)},ItemServiceImpl.prototype.beforeFinish=function(callback){this.beforeFinishCallbacks.push(callback)},ItemServiceImpl.prototype.finish=function(){for(var self=this,i=0;i<this.beforeFinishCallbacks.length;i++)this.beforeFinishCallbacks[i]();
this.submit(function(){self.serviceApi.finish()})},ItemServiceImpl.prototype.submit=function(after){var self=this;this.serviceApi.setState(JSON.stringify(self.stateVariables),function(){self.resultApi?self.resultApi.submitItemVariables(self.itemId,self.serviceApi.getServiceCallId(),self.responses,self.scores,self.events,self.params,after):after()})},ItemServiceImpl.prototype.onKill=function(callback){this.serviceApi.onKill(callback)},ItemServiceImpl.prototype.getVariable=function(identifier,callback){"function"==typeof callback&&callback(this.stateVariables[identifier]||null)},ItemServiceImpl.prototype.setVariable=function(identifier,value){this.stateVariables[identifier]=value
},ItemServiceImpl}),define("taoItems/preview-console",["jquery"],function($){function unserializeUrl(params){var data={},hashes=params.split("&");for(var i in hashes)if("string"==typeof hashes[i]){var hash=hashes[i].split("=");if(2==hash.length)if(/\[\]$/.test(hash[0])){var key=hash[0].replace(/\[\]$/,"");"undefined"==typeof data[key]&&(data[key]=[]),data[key].push(hash[1])}else data[hash[0]]=hash[1]}return data}return{setup:function(){var timer=new Date,$previewConsole=$("#preview-console",window.top.document),$consoleCtrls=$(".console-control",$previewConsole),$consoleContent=$(".console-content",$previewConsole),$consoleContentList=$(".console-content > ul",$previewConsole);
$previewConsole.bind("updateConsole",function(event,type,message){var hour=timer.getHours(),min=timer.getMinutes(),sec=timer.getSeconds(),logTime=(hour>10?hour:"0"+hour)+":"+(min>10?min:"0"+min)+":"+(sec>10?sec:"0"+sec);$consoleContentList.append("<li><b>["+logTime+"] "+type+"</b>: "+message+"</li>")}),$(".ui-icon-circle-close",$consoleCtrls).on("click",function(event){event.preventDefault(),$previewConsole.hide()}),$(".ui-icon-trash",$consoleCtrls).on("click",function(event){event.preventDefault(),$consoleContentList.empty()}),$(".toggler",$consoleCtrls).on("click",function(event){event.preventDefault(),$consoleContent.toggle(),$(this).toggleClass("ui-icon-circle-minus").toggleClass("ui-icon-circle-plus")
}),$("body").ajaxSuccess(function(event,request,settings){if(/LegacyPreviewApi/.test(settings.url)){var message="";if(/save$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));for(var key in data)"token"!==key&&(message+="<br />"+key+" = "+data[key]);""!==message&&(message+="<br />",$previewConsole.trigger("updateConsole",["push data",message]))}else if(/traceEvents$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));if(data.events){for(var index in data.events)try{var eventData=$.parseJSON(data.events[index]);message+="<br />"+eventData.type+" on element "+eventData.name,"noID"!==eventData.id&&(message+="[id="+eventData.id+"]")
}catch(exp){}message+="<br />",$previewConsole.trigger("updateConsole",["trace events",message])}}else if(/saveContext$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));for(key in data)"token"!==key&&(message+="<br />"+key+" = "+data[key]);message+="<br />",$previewConsole.trigger("updateConsole",["save context",message])}else if(/retrieveContext$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));for(key in data)"token"!==key&&(message+="<br />"+key+" = "+data[key]);message+="<br />",$previewConsole.trigger("updateConsole",["retrieved context",message])}else if(/evaluate$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));
if(data.data){try{var matchingDataList=$.parseJSON(data.data);for(key in matchingDataList)message+="<br />"+matchingDataList[key].identifier+" = "+matchingDataList[key].value}catch(exp){}message+="<br />",$previewConsole.trigger("updateConsole",["sent answers",message])}}else message="<br />"+settings.type+" "+settings.url+" ? "+decodeURIComponent(settings.data)+" => "+request.responseText,$previewConsole.trigger("updateConsole",["remote request",message])}})}}}),define("taoItems/controller/preview/itemRunner",["module","jquery","lodash","serviceApi/ServiceApi","serviceApi/PseudoStorage","serviceApi/UserInfoService","taoItems/runtime/ItemServiceImpl","taoItems/preview-console","urlParser","iframeResizer"],function(module,$,_,ServiceApi,PseudoStorage,UserInfoService,ItemServiceImpl,previewConsole,UrlParser,iframeResizer){var previewItemRunner={start:function(options){var conf=_.merge(module.config(),options||{});
if(conf.previewUrl){previewConsole.setup();var resultServer=_.defaults(conf.resultServer,{module:"taoResultServer/ResultServerApi",endpoint:"",params:{}});require([resultServer.module],function(ResultServerApi){var resultServerApi=new ResultServerApi(resultServer.endpoint,resultServer.params),serviceApi=new ServiceApi(conf.previewUrl,{},"preview",new PseudoStorage,new UserInfoService(conf.userInfoServiceRequestUrl,{})),itemApi=new ItemServiceImpl({serviceApi:serviceApi,resultApi:resultServerApi}),callUrl=new UrlParser(serviceApi.getCallUrl()),isCORSAllowed=callUrl.checkCORS();callUrl.addParam("clientConfigUrl",conf.clientConfigUrl);var $frame=$("#preview-container");
iframeResizer.autoHeight($frame,"body",10),$frame.on("load",function(){var frame=this;itemApi.connect(frame),isCORSAllowed===!0&&(frame.contentWindow.__knownParent__=!0),$(document).on("itemready",function(){itemApi.connect(frame)})}),$("#preview-container").attr("src",callUrl.getUrl()),$("#finishButton").click(function(){itemApi.finish()})})}}};return previewItemRunner}),define("taoItems/controller/runtime/itemRunner",["jquery","lodash","iframeResizer","iframeNotifier","urlParser"],function($,_,iframeResizer,iframeNotifier,UrlParser){var itemRunner={start:function(options){var $frame=$('<iframe id="item-container" class="toolframe" frameborder="0" style="width:100%;height:100%;overflow:hidden" scrolling="no"></iframe>');
$frame.appendTo("body");var itemId=options.itemId,itemPath=options.itemPath,resultServer=_.defaults(options.resultServer,{module:"taoResultServer/ResultServerApi",params:{}}),itemService=_.defaults(options.itemService,{module:"taoItems/runtime/ItemServiceImpl",params:{}}),clientConfigUrl=options.clientConfigUrl;require([itemService.module,resultServer.module],function(ItemService,ResultServerApi){var resultServerApi=new ResultServerApi(resultServer.endpoint,resultServer.params);window.onServiceApiReady=function(serviceApi){var itemApi=new ItemService(_.merge({serviceApi:serviceApi,itemId:itemId,resultApi:resultServerApi},{params:itemService.params})),itemUrl=new UrlParser(itemPath),isCORSAllowed=itemUrl.checkCORS();
itemUrl.addParam("clientConfigUrl",clientConfigUrl),iframeResizer.autoHeight($frame,"body",10),$(document).on("itemloaded",function(){iframeNotifier.parent("serviceloaded")}),$(document).on("itemready",function(){itemApi.connect($frame[0])}),$frame.on("load",function(){itemApi.connect($frame[0]),isCORSAllowed===!0&&(this.contentWindow.__knownParent__=!0)}),$frame.attr("src",itemUrl.getUrl())},iframeNotifier.parent("serviceready")})}};return itemRunner});
//# sourceMappingURL=routes.js.map