define("taoItems/controller/routes",[],function(){return{Items:{deps:"controller/items",actions:{getSectionActions:"controller/main/actions",getSectionTrees:"controller/main/trees"}},ItemPreview:{actions:{index:"controller/preview/itemRunner"}}}}),define("taoItems/controller/items",["jquery","i18n","helpers","uiBootstrap","module"],function(e,t,n,i,r){function o(n){var i=n?t("Authoring")+": "+n:t("Authoring"),r=n?t("Preview")+": "+n:t("Preview");e("a#items_authoring").html(i).attr("title",i),e("a#items_preview").html(r).attr("title",r)}var a=i.tabs,s=n.getTabIndexByName("items_authoring"),u=n.getTabIndexByName("items_preview");return{start:function(){var e=r.config();e.uri&&e.classUri?(e.isAuthoringEnabled===!0&&"authoring"!==e.action&&(a.tabs("url",s,e.authoringUrl),a.tabs("enable",s)),e.isPreviewEnabled===!0&&"preview"!==e.action&&(a.tabs("url",u,e.previewUrl),a.tabs("enable",u)),e.label&&o(e.label)):(o(),"authoring"!==e.action&&a.tabs("disable",s),"preview"!==e.action&&a.tabs("disable",u)),e.reload&&i.initTrees(),e.message&&n.createMessage(e.message)}}}),define("iframeNotifier",["jquery"],function(){function e(e){return!(!window.__knownParent__||!e||e===window)}var t={parent:function(t,n){if(e(window.parent)&&window.parent.$){var i=window.parent.$;i(window.parent.document).trigger(t,n||[])}},top:function(t,n){if(e(window.top)&&window.top.$){var i=window.top.$;i(window.top.document).trigger(t,n||[])}}};return t}),define("jquery.sizechange",["jquery"],function(e){function t(){return window.MutationObserver||window.WebKitMutationObserver||!1}function n(){var e=document.createElement("p"),t=!1;if(e.addEventListener)e.addEventListener("DOMAttrModified",function(){t=!0},!1);else{if(!e.attachEvent)return!1;e.attachEvent("onDOMAttrModified",function(){t=!0})}return e.setAttribute("id","__dummy_domtest_target"),t}e.fn.sizeChange=function(i){var r=this,o=!1;if(i=i||e.noop(),0===r.length)return r;var a=function(){o===!1&&(o=!0,setTimeout(function(){i(),o=!1},1)),r.find("img").one("load",function(){i()})};if(t()){var s=window.MutationObserver||window.WebKitMutationObserver,u={subtree:"IFRAME"!==this[0].nodeName,attributes:!0},c=new s(function(e){for(var t in e)(null!==e[t].addedNodes||null!==e[t].attributeName)&&a()});r.each(function(){c.observe(this,u)})}else{if(!n())throw new Error("Event listening not supported");r.on("DOMAttrModified",function(e){"style"===e.attrName&&a()}),r.on("DOMNodeRemoved DOMNodeInserted DOMNodeInsertedIntoDocument DOMNodeRemovedFromDocument",function(e){1===e.target.nodeType&&a()})}return this}}),define("iframeResizer",["jquery","iframeNotifier","jquery.sizechange"],function(e,t){var n={autoHeight:function(t,n,i){var r=this;return n=n||"body",i=i||0,t.on("load",function(){var o=t.contents(),a=o.height(),s=!1,u=function(){s===!1&&(s=!0,setTimeout(function(){r._adaptHeight(t,a,i),s=!1},1))};r._adaptHeight(t,a);try{e(o[0].document).find("img"),o.find(n).sizeChange(function(){var e=o.height();e>a&&(a=e,u()),e>a&&(a=e,u())})}catch(c){setInterval(function(){var e=o.height();e>a&&(a=e,u())},10)}}),t},eventHeight:function(t,n){var i=this;(!n||parseInt(n,10)<10)&&(n=10),t.on("load.eventHeight",function(){var e=parseInt(t.contents().height(),10)-parseInt(t.height(),10);e>n&&(n=e),i._adaptHeight(t,t.contents().height()+n)}),e(document).on("heightchange",function(e,r,o){o=o||0,i._adaptHeight(t,r+o+n)})},_notifyParent:function(e,n){t.parent("heightchange",[e,n||0])},_adaptHeight:function(e,t,n){e.height(t),this._notifyParent(t,n)}};return n}),define("serviceApi/ServiceApi",["jquery","urlParser","iframeResizer"],function(e,t){function n(e,t,n,i,r){this.baseUrl=e,this.parameters=t,this.connected=!1,this.serviceCallId=n,this.state=i,this.userService=r,this.onFinishCallback,this.onDisplayChangeCallback}return n.prototype.loadInto=function(n,i){var r=this,o=this.getCallUrl(),a=new t(o).checkCORS();e(n).one("load",function(){e(document).on("serviceready",function(){r.connect(n,i)})}).on("load.cors",function(){a===!0&&(n.contentWindow.__knownParent__=!0)}),e(n).attr("src",o)},n.prototype.connect=function(e,t){this.connected===!1&&e.contentWindow&&"function"==typeof e.contentWindow.onServiceApiReady&&(e.contentWindow.onServiceApiReady(this),this.connected=!0,"function"==typeof t&&t())},n.prototype.getCallUrl=function(){var t=this.parameters||{};return t.serviceCallId=this.serviceCallId,this.baseUrl+"?"+e.param(t)},n.prototype.getUserPropertyValues=function(e,t){this.userService.get(e,t)},n.prototype.getServiceCallId=function(){return this.serviceCallId},n.prototype.getState=function(){return this.state.get()},n.prototype.setState=function(e,t){return this.state.set(e,t)},n.prototype.getParameter=function(e){return"undefined"!=typeof this.parameters[e]?this.parameters[e]:null},n.prototype.onFinish=function(e){this.onFinishCallback=e},n.prototype.finish=function(e){"function"==typeof this.onFinishCallback&&this.onFinishCallback(e)},n}),define("serviceApi/PseudoStorage",[],function(){function e(){}return e.prototype.get=function(e){return"function"==typeof e&&e(null),null},e.prototype.set=function(e,t){"function"==typeof t&&t()},e}),define("serviceApi/UserInfoService",["jquery"],function(e){function t(e,t){this.data=t,this.requestUrl=e}return t.prototype.get=function(t,n){this.data.hasOwnProperty(t)?"function"==typeof n&&n(this.data[t]):e.ajax({url:this.requestUrl,data:{property:t},type:"post",dataType:"json",success:function(e,n){return function(i){for(key in i.data)e.data[key]=i.data[key];"function"==typeof n&&n(e.data[t])}}(this,n)})},t}),this.JSON||(this.JSON={}),function(){function f(e){return 10>e?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,i,r,o,a,s=gap,u=t[e];switch(u&&"object"==typeof u&&"function"==typeof u.toJSON&&(u=u.toJSON(e)),"function"==typeof rep&&(u=rep.call(t,e,u)),typeof u){case"string":return quote(u);case"number":return isFinite(u)?String(u):"null";case"boolean":case"null":return String(u);case"object":if(!u)return"null";if(gap+=indent,a=[],"[object Array]"===Object.prototype.toString.apply(u)){for(o=u.length,n=0;o>n;n+=1)a[n]=str(n,u)||"null";return r=0===a.length?"[]":gap?"[\n"+gap+a.join(",\n"+gap)+"\n"+s+"]":"["+a.join(",")+"]",gap=s,r}if(rep&&"object"==typeof rep)for(o=rep.length,n=0;o>n;n+=1)i=rep[n],"string"==typeof i&&(r=str(i,u),r&&a.push(quote(i)+(gap?": ":":")+r));else for(i in u)Object.hasOwnProperty.call(u,i)&&(r=str(i,u),r&&a.push(quote(i)+(gap?": ":":")+r));return r=0===a.length?"{}":gap?"{\n"+gap+a.join(",\n"+gap)+"\n"+s+"}":"{"+a.join(",")+"}",gap=s,r}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,n){var i;if(gap="",indent="","number"==typeof n)for(i=0;n>i;i+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var n,i,r=e[t];if(r&&"object"==typeof r)for(n in r)Object.hasOwnProperty.call(r,n)&&(i=walk(r,n),void 0!==i?r[n]=i:delete r[n]);return reviver.call(e,t,r)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),define("json2",function(e){return function(){var t;return t||e.JSON}}(this)),define("taoItems/runtime/ItemServiceImpl",["jquery","json2"],function(e,t){function n(t){this.itemId=t.itemId,this.serviceApi=t.serviceApi,this.resultApi=t.resultApi||null,this.responses={},this.scores={},this.events={},this.connected=!1;var n=this.serviceApi.getState(),i="undefined"==typeof n||null===n?{}:e.parseJSON(n);this.stateVariables="object"==typeof i?i:{},this.beforeFinishCallbacks=[]}return n.prototype.connect=function(e){this.connected===!1&&e.contentWindow&&(e.contentWindow.itemApi=this,"function"==typeof e.contentWindow.onItemApiReady&&(e.contentWindow.onItemApiReady(this),this.connected=!0))},n.prototype.saveResponses=function(e){for(var t in e)this.responses[t]=e[t]},n.prototype.traceEvents=function(e){for(var t in e)this.events[t]=e[t]},n.prototype.saveScores=function(e){for(var t in e)this.scores[t]=e[t]},n.prototype.getUserPropertyValues=function(e,t){this.serviceApi.getUserPropertyValues(e,t)},n.prototype.beforeFinish=function(e){this.beforeFinishCallbacks.push(e)},n.prototype.finish=function(){for(var e=this,n=0;n<this.beforeFinishCallbacks.length;n++)this.beforeFinishCallbacks[n]();this.serviceApi.setState(t.stringify(this.stateVariables),function(){e.resultApi?e.resultApi.submitItemVariables(e.itemId,e.serviceApi.getServiceCallId(),e.responses,e.scores,e.events,function(){e.serviceApi.finish()}):e.serviceApi.finish()})},n.prototype.getVariable=function(e,t){"function"==typeof t&&t(this.stateVariables[e]||null)},n.prototype.setVariable=function(e,t){this.stateVariables[e]=t},n}),define("taoItems/preview-console",["jquery"],function(e){function t(e){var t={},n=e.split("&");for(var i in n)if("string"==typeof n[i]){var r=n[i].split("=");if(2==r.length)if(/\[\]$/.test(r[0])){var o=r[0].replace(/\[\]$/,"");"undefined"==typeof t[o]&&(t[o]=[]),t[o].push(r[1])}else t[r[0]]=r[1]}return t}return{setup:function(){var n=new Date,i=e("#preview-console",window.top.document),r=e(".console-control",i),o=e(".console-content",i),a=e(".console-content > ul",i);i.bind("updateConsole",function(e,t,i){var r=n.getHours(),o=n.getMinutes(),s=n.getSeconds(),u=(r>10?r:"0"+r)+":"+(o>10?o:"0"+o)+":"+(s>10?s:"0"+s);a.append("<li><b>["+u+"] "+t+"</b>: "+i+"</li>")}),e(".ui-icon-circle-close",r).on("click",function(e){e.preventDefault(),i.hide()}),e(".ui-icon-trash",r).on("click",function(e){e.preventDefault(),a.empty()}),e(".toggler",r).on("click",function(t){t.preventDefault(),o.toggle(),e(this).toggleClass("ui-icon-circle-minus").toggleClass("ui-icon-circle-plus")}),e("body").ajaxSuccess(function(n,r,o){if(/LegacyPreviewApi/.test(o.url)){var a="";if(/save$/.test(o.url)){var s=t(decodeURIComponent(o.data));for(var u in s)"token"!==u&&(a+="<br />"+u+" = "+s[u]);""!==a&&(a+="<br />",i.trigger("updateConsole",["push data",a]))}else if(/traceEvents$/.test(o.url)){var s=t(decodeURIComponent(o.data));if(s.events){for(var c in s.events)try{var f=e.parseJSON(s.events[c]);a+="<br />"+f.type+" on element "+f.name,"noID"!==f.id&&(a+="[id="+f.id+"]")}catch(p){}a+="<br />",i.trigger("updateConsole",["trace events",a])}}else if(/saveContext$/.test(o.url)){var s=t(decodeURIComponent(o.data));for(u in s)"token"!==u&&(a+="<br />"+u+" = "+s[u]);a+="<br />",i.trigger("updateConsole",["save context",a])}else if(/retrieveContext$/.test(o.url)){var s=t(decodeURIComponent(o.data));for(u in s)"token"!==u&&(a+="<br />"+u+" = "+s[u]);a+="<br />",i.trigger("updateConsole",["retrieved context",a])}else if(/evaluate$/.test(o.url)){var s=t(decodeURIComponent(o.data));if(s.data){try{var l=e.parseJSON(s.data);for(u in l)a+="<br />"+l[u].identifier+" = "+l[u].value}catch(p){}a+="<br />",i.trigger("updateConsole",["sent answers",a])}}else a="<br />"+o.type+" "+o.url+" ? "+decodeURIComponent(o.data)+" => "+r.responseText,i.trigger("updateConsole",["remote request",a])}})}}}),define("taoItems/controller/preview/itemRunner",["module","jquery","lodash","serviceApi/ServiceApi","serviceApi/PseudoStorage","serviceApi/UserInfoService","taoItems/runtime/ItemServiceImpl","taoItems/preview-console","urlParser"],function(e,t,n,i,r,o,a,s,u){var c={start:function(c){var f=n.merge(e.config(),c||{});if(f.previewUrl){s.setup();var p=n.defaults(f.resultServer,{module:"taoResultServer/ResultServerApi",endpoint:"",params:{}});require([p.module],function(e){var n=new e(p.endpoint,p.params),s=new i(f.previewUrl,{},"preview",new r,new o(f.userInfoServiceRequestUrl,{})),c=new a({serviceApi:s,resultApi:n}),l=s.getCallUrl(),d=new u(l).checkCORS();t("#preview-container").one("load",function(){var e=this;c.connect(e),d===!0&&(e.contentWindow.__knownParent__=!0),t(document).on("itemready",function(){c.connect(e)})}),t("#preview-container").attr("src",s.getCallUrl()),t("#finishButton").click(function(){c.finish()})})}}};return c}),define("taoItems/controller/runtime/itemRunner",["jquery","lodash","iframeResizer","iframeNotifier"],function(e,t,n,i){var r={start:function(r){var o=e("#item-container"),a=r.itemId,s=r.itemPath,u=t.defaults(r.resultServer,{module:"taoResultServer/ResultServerApi",params:{}}),c=t.defaults(r.itemService,{module:"taoItems/runtime/ItemServiceImpl",params:{}});require([c.module,u.module],function(r,f){var p=new f(u.endpoint,u.params);window.onServiceApiReady=function(i){var u=new r(t.merge({serviceApi:i,itemId:a,resultApi:p},c.params));n.autoHeight(o,"body",10),o.load(function(){var t=this;u.connect(t),e(document).on("itemready",function(){u.connect(t)})}).attr("src",s)},i.parent("serviceready")})}};return r});