{"version":3,"file":"routes.js","sources":["routes.js","items/edit.js","../../serviceApi/ServiceApi.js","../../serviceApi/PseudoStorage.js","../../serviceApi/UserInfoService.js","../runtime/ItemServiceImpl.js","../preview-console.js","preview/itemRunner.js","runtime/itemRunner.js"],"names":[],"mappings":"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","sourcesContent":["/**\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2014 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\n * \n * \n */\n\n//@see http://forge.taotesting.com/projects/tao/wiki/Front_js\ndefine('taoItems/controller/routes',[],function(){\n    'use strict';\n    \n    return {\n        'Items' : {\n            'actions' : {\n                'editItem' : 'controller/items/edit'\n            }\n        },\n        'ItemPreview' : {\n            'actions' : {\n                'index' : 'controller/preview/itemRunner'\n            }\n        }\n    };\n});\n\n","\ndefine('taoItems/controller/items/edit',['module', 'layout/actions'], function(module, actions){\n\n        var editItemController = {\n            start : function(options){\n                var config = module.config();\n        \n                var isPreviewEnabled = !!config.isPreviewEnabled;\n                var isAuthoringEnabled = !!config.isAuthoringEnabled;\n   \n                var previewAction = actions.getBy('item-preview');\n                var authoringAction = actions.getBy('item-authoring');\n               \n                if(previewAction){ \n                    previewAction.state.disabled = !config.isPreviewEnabled;\n                }\n                if(authoringAction){\n                    authoringAction.state.disabled = !config.isAuthoringEnabled;\n                }\n                actions.updateState(); \n            }\n        };\n\n        return editItemController;\n});\n\n","define('serviceApi/ServiceApi',['jquery', 'urlParser', 'iframeResizer'], function($, UrlParser, iframeResizer){\n    \n    function ServiceApi(baseUrl, parameters, serviceCallId, stateStorage, userService){\n        this.baseUrl = baseUrl;\n        this.parameters = parameters;\n        this.connected = false;\n\n        this.serviceCallId = serviceCallId; \n        this.state = stateStorage;\n        this.userService = userService;\n\n        this.onFinishCallback;\n        this.onKillCallback;\n        this.onDisplayChangeCallback;\n    }\n\n    ServiceApi.SIG_SUCCESS = 0; \n    ServiceApi.SIG_ERROR = 1;\n        \n    ServiceApi.prototype.loadInto = function(frame, connected){\n        var self = this;\n        var $frame = $(frame);\n        var callUrl = this.getCallUrl();        \n        var isCORSAllowed = new UrlParser(callUrl).checkCORS();\n\n        $frame.one('load', function() {\n            $(document).on('serviceready', function(){\n                self.connect(frame, connected );\n            });\n            \n        }).on('load.cors', function(e){\n            //if we are  in the same domain, we add a variable\n            //to the frame window, so the frame knows it can communicate\n            //with the parent\n            if(isCORSAllowed === true){\n                frame.contentWindow.__knownParent__ = true;\n            }\n        });\n        $frame.attr('src', callUrl);\n    };\n\n    ServiceApi.prototype.connect = function(frame, connected){\n        if(this.connected === false && frame.contentWindow){\n            //frame.contentWindow.serviceApi = this;\n            if (typeof(frame.contentWindow.onServiceApiReady) === \"function\") {\n                frame.contentWindow.onServiceApiReady(this);\n                this.connected = true;\n                if(typeof connected === 'function'){\n                    connected();\n                }\n            }\n        }\n    };\n    \n    /**\n     * Get the service call URL\n     * @returns {String} the URI\n     */\n    ServiceApi.prototype.getCallUrl = function(){\n        var params = this.parameters || {};\n        params.serviceCallId = this.serviceCallId;\n        return this.baseUrl + '?' + $.param(params);\n    };\n\n    ServiceApi.prototype.getUserPropertyValues = function(property, callback){\n    \tthis.userService.get(property, callback);\n    };\n    \n    //Context\n    ServiceApi.prototype.getServiceCallId = function(){\n        return this.serviceCallId;\n    };\n\n    //Context\n    ServiceApi.prototype.getState = function(){\n        return this.state.get();\n    };\n\n    ServiceApi.prototype.setState = function(state, callback){\n        return this.state.set(state, callback);\n    };\n\n    // Variables \n    ServiceApi.prototype.getParameter = function(identifier){\n        if (typeof(this.parameters[identifier]) !== \"undefined\") {\n            return this.parameters[identifier];\n        } else {\n            return null;\n        }\n    };\n\n    ServiceApi.prototype.onFinish = function(callback) {\n        this.onFinishCallback = callback;\t\n    };\n\n    ServiceApi.prototype.onKill = function(callback) {\n        this.onKillCallback = callback;\t\n    };\n    \n    ServiceApi.prototype.kill = function(callback) {\n    \tif (typeof this.onKillCallback == 'function') {\n    \t\tthis.onKillCallback(callback);\n    \t} else {\n    \t\tcallback(0);\n    \t}\n    };\n    \n    // Flow\n    // valueArray are return parameters of the service.\n    ServiceApi.prototype.finish = function(valueArray) {\n            //return execution to service caller\n            if (typeof this.onFinishCallback === 'function') {\n                    this.onFinishCallback(valueArray);\n            }\n    };\n\n    return ServiceApi;\n\n});\n\n","define('serviceApi/PseudoStorage',[],function(){\n    \n    function PseudoStorage() {\n    }\n\n    PseudoStorage.prototype.get = function(callback){\n        if (typeof callback === 'function') {\n            callback(null);\n        }\n        return null;\n    };\n\n    PseudoStorage.prototype.set = function(state, callback){\n        if (typeof callback === \"function\") {\n            callback();\n        }\n    };\n\n    return PseudoStorage;\n});\n","define('serviceApi/UserInfoService',['jquery'], function($){\n    \n    function UserInfoService(requestUrl, data) {\n        this.data = data;\n        this.requestUrl = requestUrl;\n    }\n\n    UserInfoService.prototype.get = function(property, callback){\n        if (this.data.hasOwnProperty(property)) {\n            if (typeof callback === \"function\") {\n                    callback(this.data[property]);\n            }\n        } else {\n            $.ajax({\n                url : this.requestUrl,\n                data \t\t: {\n                    'property' : property\n                },\n                type        : 'post',\n                dataType\t: 'json',\n                success     : (function(service, callback) {return function(r) {\n            \t\tfor (key in r.data) {\n            \t\t\tservice.data[key] = r.data[key];\n            \t\t}\n                    if (typeof callback === \"function\") {\n                        callback(service.data[property]);\n                    }\n\n                }})(this, callback)\n                /*\t\n            \tfunction(r){\n                    if(r.success){\n                    \tconsole.log(this.data);\n                    \tthis.data[property] = r.values;\n                    \t//console.log(this.data);\n\t                    if (typeof callback === \"function\") {\n\t                        callback(this.data[property]);\n\t                    }\n                    }\n                }\n                */\n                \n                \n            });\n        }\n    };\n\n    return UserInfoService;\n});\n","define('taoItems/runtime/ItemServiceImpl',[ 'jquery' ], function($) {\n\n    function ItemServiceImpl(data) {\n\n        this.itemId = data.itemId;\n        this.serviceApi = data.serviceApi;\n        this.resultApi = data.resultApi || null;\n        this.params = data.params || {};\n        this.responses = {};\n        this.scores = {};\n        this.events = {};\n        this.connected = false;\n\n        var rawstate = this.serviceApi.getState();\n        var state = (typeof rawstate === 'undefined' || rawstate === null) ? {}\n                : $.parseJSON(rawstate);\n        this.stateVariables = typeof state === 'object' ? state : {};\n\n        this.beforeFinishCallbacks = [];\n    }\n\n    ItemServiceImpl.prototype.connect = function(frame) {\n        if (this.connected === false && frame.contentWindow) {\n            frame.contentWindow.itemApi = this;\n            \n            if (typeof (frame.contentWindow.onItemApiReady) === \"function\") {\n                frame.contentWindow.onItemApiReady(this);\n                this.connected = true;\n            }\n        }\n    };\n\n    // Response\n\n    ItemServiceImpl.prototype.saveResponses = function(valueArray) {\n        for ( var attrname in valueArray) {\n            this.responses[attrname] = valueArray[attrname];\n        }\n    };\n\n    ItemServiceImpl.prototype.traceEvents = function(eventArray) {\n        for ( var attrname in eventArray) {\n            this.events[attrname] = eventArray[attrname];\n        }\n    };\n\n    // Scoring\n    ItemServiceImpl.prototype.saveScores = function(valueArray) {\n        for ( var attrname in valueArray) {\n            this.scores[attrname] = valueArray[attrname];\n        }\n    };\n\n    ItemServiceImpl.prototype.getUserPropertyValues = function(property,\n            callback) {\n        this.serviceApi.getUserPropertyValues(property, callback);\n    };\n\n    // Flow\n    ItemServiceImpl.prototype.beforeFinish = function(callback) {\n        this.beforeFinishCallbacks.push(callback);\n    };\n\n    ItemServiceImpl.prototype.finish = function() {\n        var self = this;\n        for ( var i = 0; i < this.beforeFinishCallbacks.length; i++) {\n            this.beforeFinishCallbacks[i]();\n        }\n\n        this.submit(function() {\n            self.serviceApi.finish();\n        });\n    };\n\n    ItemServiceImpl.prototype.submit = function(after) {\n        var self = this;\n\n        this.serviceApi.setState(JSON.stringify(self.stateVariables),\n                function() {\n                    // todo add item, call id etc\n\n                    if (self.resultApi) {\n                        self.resultApi\n                                .submitItemVariables(self.itemId,\n                                        self.serviceApi.getServiceCallId(),\n                                        self.responses, self.scores,\n                                        self.events, self.params, after);\n                    } else {\n                        after();\n                    }\n                });\n    }\n\n    ItemServiceImpl.prototype.onKill = function(callback) {\n        this.serviceApi.onKill(callback);\n    };\n\n    ItemServiceImpl.prototype.getVariable = function(identifier, callback) {\n        if (typeof callback === 'function') {\n            callback(this.stateVariables[identifier] || null);\n        }\n    };\n\n    ItemServiceImpl.prototype.setVariable = function(identifier, value) {\n        this.stateVariables[identifier] = value;\n    };\n\n    return ItemServiceImpl;\n});\n","/*  \n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n * \n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n * \n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n * \n * Copyright (c) 2008-2010 (original work) Deutsche Institut für Internationale Pädagogische Forschung (under the project TAO-TRANSFER);\n *               2009-2012 (update and modification) Public Research Centre Henri Tudor (under the project TAO-SUSTAIN & TAO-DEV);\n * \n */\ndefine('taoItems/preview-console',['jquery'], function($){\n    /**\n     * Get an url-formated parameters string, parse it and return a JSONized object\n     * @param {String} params\n     * @returns {Object}\n     */\n    function unserializeUrl(params){\n        var data = {};\n        var hashes = params.split('&');\n        for(var i in hashes){\n                    if(typeof hashes[i] == 'string'){\n                            var hash = hashes[i].split('=');\n                            if(hash.length == 2){\n                                    if(/\\[\\]$/.test(hash[0])){\n                                            var key = hash[0].replace(/\\[\\]$/, '');\n                                            if(typeof(data[key]) == \"undefined\"){\n                                                    data[key] = [];\n                                            }\n                                            data[key].push(hash[1]);\n                                    }\n                                    else{\n                                            data[hash[0]] = hash[1];\n                                    }\n                            }\n                    }\n        }\n        return data;\n    }\n    \n    return {\n        \n        setup : function(){\n    \n\tvar timer = new Date();\n\t\n\t//get the console element in the top page\n\tvar $previewConsole = $('#preview-console', window.top.document);\n        var $consoleCtrls = $('.console-control', $previewConsole);\n        var $consoleContent = $('.console-content', $previewConsole);\n        var $consoleContentList = $('.console-content > ul', $previewConsole);\n\t\n\t//attach an updateConsole event, tobe triggered\n\t$previewConsole.bind('updateConsole', function(event, type, message){\n\t\tvar hour = timer.getHours();\n\t\tvar min\t = timer.getMinutes();\n\t\tvar sec\t = timer.getSeconds();\n\t\tvar logTime = ((hour>10)? hour : '0'+hour ) + ':' + ((min>10)? min : '0'+min) + ':' + ((sec>10)? sec: '0'+sec);\n\t\t$consoleContentList.append('<li><b>[' +  logTime  + '] ' + type + '</b>: ' + message + '</li>');\n\t});\n\t\n\t//controls: close console\n\t$(\".ui-icon-circle-close\", $consoleCtrls).on('click', function(event){\n                event.preventDefault();\n\t\t$previewConsole.hide();\n\t});\n\t\n\t//controls: clean console\n        $('.ui-icon-trash', $consoleCtrls).on('click', function(event){\n                event.preventDefault();\n\t\t$consoleContentList.empty();\n\t});\n\t\n\t//controls: show/hide console\n        $(\".toggler\", $consoleCtrls).on('click', function(event){\n                event.preventDefault();\n\t\t$consoleContent.toggle();\n                $(this).toggleClass('ui-icon-circle-minus')\n                        .toggleClass('ui-icon-circle-plus');\n\t});\n\t\n\t//log in the console the ajax request to the Preview Api\n\t$('body').ajaxSuccess(function(event, request, settings){\n\t\t\n\t\tif(/LegacyPreviewApi/.test(settings.url)){\n\t\t\t\n\t\t\tvar message = '';\n\t\t\t//taoApi Push\n\t\t\tif(/save$/.test(settings.url)){\n\t\t\t\tvar data = unserializeUrl(decodeURIComponent(settings.data));\n\t\t\t\tfor(var key in data){\n\t\t\t\t\tif(key !== 'token'){\n\t\t\t\t\t\tmessage += '<br />' + key + ' = '  + data[key] ;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(message !== ''){\n\t\t\t\t\tmessage += '<br />';\n\t\t\t\t\t$previewConsole.trigger('updateConsole', ['push data', message]);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t//taoApi events\n\t\t\telse if(/traceEvents$/.test(settings.url)){\n\t\t\t\tvar data = unserializeUrl(decodeURIComponent(settings.data));\n\t\t\t\tif(data.events){\n\t\t\t\t\tfor(var index in data.events){\n\t\t\t\t\t\ttry{\n\t\t\t\t\t\t\tvar eventData = $.parseJSON(data.events[index]);\n\t\t\t\t\t\t\tmessage += '<br />' + eventData.type + ' on element ' + eventData.name;\n\t\t\t\t\t\t\tif(eventData.id !== 'noID'){\n\t\t\t\t\t\t\t\tmessage += '[id=' + eventData.id +']';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}catch(exp){ }\n\t\t\t\t\t}\n\t\t\t\t\tmessage += '<br />';\n\t\t\t\t\t$previewConsole.trigger('updateConsole', ['trace events', message]);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t//wfApi saving context \n\t\t\telse if(/saveContext$/.test(settings.url)){\n\t\t\t\tvar data = unserializeUrl(decodeURIComponent(settings.data));\n\t\t\t\t\tfor(key in data){\n\t\t\t\t\t\tif(key !== 'token'){\n\t\t\t\t\t\t\tmessage += '<br />' + key + ' = ' + data[key];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmessage += '<br />';\n\t\t\t\t\t$previewConsole.trigger('updateConsole', ['save context', message]);\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t//wfApi retrieve context \n\t\t\telse if(/retrieveContext$/.test(settings.url)){\n\t\t\t\tvar data = unserializeUrl(decodeURIComponent(settings.data));\n\t\t\t\t\tfor(key in data){\n\t\t\t\t\t\tif(key !== 'token'){\n\t\t\t\t\t\t\tmessage += '<br />' + key + ' = ' + data[key];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmessage += '<br />';\n\t\t\t\t\t$previewConsole.trigger('updateConsole', ['retrieved context', message]);\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\t//taoMatching data\n\t\t\telse if(/evaluate$/.test(settings.url)){\n\t\t\t\tvar data = unserializeUrl(decodeURIComponent(settings.data));\n\t\t\t\tif(data.data){\n\t\t\t\t\ttry{\n\t\t\t\t\t\tvar matchingDataList = $.parseJSON(data.data);\n\t\t\t\t\t\tfor(key in matchingDataList){\n\t\t\t\t\t\t\tmessage += '<br />' + matchingDataList[key]['identifier'] + ' = ' + matchingDataList[key]['value'];\n\t\t\t\t\t\t}\n\t\t\t\t\t}catch(exp){ \n\t\t\t\t\t\t//console.log(exp);\n\t\t\t\t\t}\n\t\t\t\t\tmessage += '<br />';\n\t\t\t\t\t$previewConsole.trigger('updateConsole', ['sent answers', message]);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t//others requests\n\t\t\telse{\n\t\t\t\tmessage = \t'<br />' + \n\t\t\t\t\t\t\tsettings.type + ' ' + \n\t\t\t\t\t\t\tsettings.url + ' ? ' + \n\t\t\t\t\t\t\tdecodeURIComponent(settings.data) + ' => ' +\n\t\t\t\t\t\t\trequest.responseText;\n\t\t\t\t$previewConsole.trigger('updateConsole', ['remote request', message]);\n\t\t\t}\n\t\t}\n            });\n        }\n    };\n});\n","/**\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2013 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\n *\n *\n */\ndefine(\n    'taoItems/controller/preview/itemRunner',[\n        'module',\n        'jquery',\n        'lodash',\n        'serviceApi/ServiceApi',\n        'serviceApi/PseudoStorage',\n        'serviceApi/UserInfoService',\n        'taoItems/runtime/ItemServiceImpl',\n        'taoItems/preview-console',\n        'urlParser',\n        'iframeResizer'\n    ],\n    function (\n        module,\n        $,\n        _,\n        ServiceApi,\n        PseudoStorage,\n        UserInfoService,\n        ItemServiceImpl,\n        previewConsole,\n        UrlParser,\n        iframeResizer\n        ) {\n\n        var previewItemRunner = {\n\n            start: function (options) {\n\n                var conf = _.merge(module.config(), options || {});\n\n                if (conf.previewUrl) {\n\n                    previewConsole.setup();\n\n                    var resultServer = _.defaults(conf.resultServer, {\n                        module: 'taoResultServer/ResultServerApi',\n                        endpoint: '',\n                        params: {}\n                    });\n\n                    //load dynamically the right ResultServerApi\n                    require([resultServer.module], function (ResultServerApi) {\n\n                        var resultServerApi = new ResultServerApi(\n                            resultServer.endpoint,\n                            resultServer.params\n                        );\n\n                        var serviceApi = new ServiceApi(\n                            conf.previewUrl,\n                            {},\n                            'preview',\n                            new PseudoStorage(),\n                            new UserInfoService(conf.userInfoServiceRequestUrl, {})\n                        );\n\n                        var itemApi = new ItemServiceImpl({\n                            serviceApi: serviceApi,\n                            resultApi: resultServerApi\n                        });\n\n                        var callUrl = new UrlParser(serviceApi.getCallUrl());\n                        var isCORSAllowed = callUrl.checkCORS();\n                        callUrl.addParam('clientConfigUrl', conf.clientConfigUrl);\n\n                        var $frame = $('#preview-container');\n\n                        iframeResizer.autoHeight($frame, 'body', 10);\n\n\n\n                        $frame.on('load', function () {\n                            var frame = this;\n\n                            //1st try to connect the api on frame load\n                            itemApi.connect(frame);\n\n                            //if we are  in the same domain, we add a variable\n                            //to the frame window, so the frame knows it can communicate\n                            //with the parent\n                            if (isCORSAllowed === true) {\n                                frame.contentWindow.__knownParent__ = true;\n                            }\n                            //then we can wait a specific event triggered from the item\n                            $(document).on('itemready', function () {\n                                itemApi.connect(frame);\n                            });\n\n                        });\n                        $('#preview-container').attr('src', callUrl.getUrl());\n\n                        $('#finishButton').click(function () {\n                            itemApi.finish();\n                        });\n                    });\n                }\n            }\n        };\n\n        return previewItemRunner;\n    });\n","/**\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2013 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\n *\n *\n */\ndefine('taoItems/controller/runtime/itemRunner',['jquery', 'lodash', 'iframeResizer', 'iframeNotifier', 'urlParser'],\n    function($, _, iframeResizer, iframeNotifier, UrlParser){\n\n        var itemRunner = {\n            start : function(options){\n\n                var $frame = $('<iframe id=\"item-container\" class=\"toolframe\" frameborder=\"0\" style=\"width:100%;height:100%;overflow:hidden\" scrolling=\"no\"></iframe>');\n                $frame.appendTo('body');\n                var itemId = options.itemId;\n                var itemPath = options.itemPath;\n                var resultServer = _.defaults(options.resultServer, {\n                    module : 'taoResultServer/ResultServerApi',\n                    params : {}\n                });\n                var itemService = _.defaults(options.itemService, {\n                    module : 'taoItems/runtime/ItemServiceImpl',\n                    params : {}\n                });\n                var clientConfigUrl = options.clientConfigUrl;\n\n                //load dynamically the right ItemService and ResultServerApi\n                require([itemService.module, resultServer.module], function(ItemService, ResultServerApi){\n\n                    var resultServerApi = new ResultServerApi(resultServer.endpoint, resultServer.params);\n\n                    window.onServiceApiReady = function(serviceApi){\n                        \n                        var itemApi = new ItemService(_.merge({\n                            serviceApi : serviceApi,\n                            itemId : itemId,\n                            resultApi : resultServerApi\n                        }, {\n                            params : itemService.params\n                        }));\n\n                        var itemUrl = new UrlParser(itemPath);\n                        var isCORSAllowed = itemUrl.checkCORS();\n                        itemUrl.addParam('clientConfigUrl', clientConfigUrl);\n\n                        iframeResizer.autoHeight($frame, 'body', 10);\n                        \n                        $(document).on('itemloaded', function() {\n                            iframeNotifier.parent('serviceloaded');\n                        });\n                        \n                        $(document).on('itemready', function() {\n                            // item is ready, we can connect.\n                            itemApi.connect($frame[0]);\n                        });\n                        \n                        $frame.on('load', function(){\n                            itemApi.connect($frame[0]);\n                            \n                            if (isCORSAllowed === true) {\n                                this.contentWindow.__knownParent__ = true;\n                            }\n                        });                        \n                        $frame.attr('src', itemUrl.getUrl());\n                    };\n\n                    //tell the parent he can trigger onServiceApiReady\n                    iframeNotifier.parent('serviceready');\n                });\n            }\n        };\n\n        return itemRunner;\n    });\n\n"]}